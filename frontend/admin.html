<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SUAT éƒ¨é•¿ç®¡ç†åå°</title>
    <style>
        body { font-family: 'PingFang SC', sans-serif; background: #f4f7f9; padding: 30px; }
        .dashboard { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #1890ff; border-bottom: 2px solid #1890ff; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; }
        .status-active { color: #52c41a; font-weight: bold; }
        .status-timeout { color: #f5222d; font-weight: bold; }
        .role-badge { background: #e6f7ff; color: #1890ff; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
<div class="dashboard">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>ğŸ‘¨â€ğŸ’¼ SUAT æ‹›è˜å·¡é€»åå°</h1>
        <button onclick="logout()" style="background: #ff4d4f; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer;">
            é€€å‡ºç™»å½•
        </button>
    </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>ç”¨æˆ·å</th>
                <th>å½“å‰è§’è‰²</th>
                <th>æœ€åæ´»è·ƒæ—¶é—´</th>
                <th>ç‰©ç†çŠ¶æ€</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="user-list">
            </tbody>
    </table>
</div>

<script>
    // åœ¨ fetchUsers å‡½æ•°ä¹‹å‰åŠ å…¥
    const token = localStorage.getItem('token');
    if (!token) {
        // ç‰©ç†æ‹¦æˆªï¼šæ²¡ç™»å½•å°±æ»šå›ç™»å½•é¡µï¼Œå¹¶å‘Šè¯‰ç™»å½•é¡µç™»å½•å®Œå†å› admin.html
        window.location.href = 'login.html?redirect=admin.html';
    }
    
    function logout() {
        // 1. æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„æ‰€æœ‰ä¿¡æ¯ï¼ˆTokenã€ç”¨æˆ·åç­‰ï¼‰
        localStorage.clear();
        
        // 2. ç‰©ç†é‡å®šå‘åˆ°ç™»å½•é¡µ
        // è¿™é‡Œä¸éœ€è¦ä¼  redirectï¼Œå› ä¸ºæ˜¯ä¸»åŠ¨é€€å‡ºï¼Œé»˜è®¤ä¸‹æ¬¡è¿›é¦–é¡µ
        window.location.href = 'login.html';
    }

    // ç‰©ç†è·å–æ‰€æœ‰é¢è¯•è€…ä¿¡æ¯
    async function fetchUsers() {
        const token = localStorage.getItem('token');
        if(!token) return window.location.href = 'login.html';

        try {
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æˆ‘ä»¬åœ¨åç«¯ RecruitController è¡¥ä¸€ä¸ª listAll çš„æ¥å£
            const res = await fetch('http://localhost:8080/api/recruit/list', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const users = await res.json();
            const container = document.getElementById('user-list');
            container.innerHTML = users.map(user => `
                <tr>
                    <td>${user.username}</td>
                    <td><span class="role-badge">${user.role}</span></td>
                    <td>${new Date(user.lastHeartbeat).toLocaleString()}</td>
                    <td><span class="${user.status === 'ACTIVE' ? 'status-active' : 'status-timeout'}">
                        ${user.status === 'ACTIVE' ? 'æ­£åœ¨é¢è¯•' : 'å·²å–æ¶ˆèµ„æ ¼ (è¶…æ—¶)'}
                    </span></td>
                    <td>
                        <button onclick="viewChat('${user.username}')">æŸ¥çœ‹è®°å½•</button>
                    </td>
                </tr>
            `).join('');
        } catch (e) {
            alert("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™");
        }
    }

    window.onload = fetchUsers;
</script>
</body>
</html>