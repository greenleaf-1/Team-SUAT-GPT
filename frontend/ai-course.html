<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åå¸ˆç½‘AIåˆ¶è¯¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        /* 100% ç»§æ‰¿ä½ æä¾›çš„æ ·å¼ */
        body { margin: 0; font-family: 'PingFang SC', sans-serif; background: #f0f2f5; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 240px; background: #fff; border-right: 1px solid #dcdfe6; display: flex; flex-direction: column; }
        .logo { padding: 25px; font-size: 22px; font-weight: bold; color: #409EFF; border-bottom: 1px solid #f2f6fc; }
        .main-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .header { height: 60px; background: #fff; display: flex; align-items: center; justify-content: flex-end; padding: 0 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .workspace { padding: 30px 40px; flex: 1; max-width: 1100px; margin: 0 auto; width: 100%; }
        .step-nav { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
        .content-card { background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .radar-chart { width: 100%; height: 380px; }
        .history-item { padding: 10px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 14px; }
        .history-item:hover { background: #f5f7fa; }
        /* é€‰ä¸­çŠ¶æ€çš„è§†è§‰åé¦ˆ [cite: 2026-02-19] */
        .style-card { 
            border: 2px solid #f2f6fc; 
            border-radius: 8px; 
            padding: 40px 20px; 
            cursor: pointer; 
            text-align: center; 
            transition: all 0.3s; 
            background: #fff;
        }
        .style-card:hover { border-color: #409EFF; }
        .style-card.selected { 
            border-color: #409EFF; 
            background: #ecf5ff; 
            box-shadow: 0 4px 12px rgba(64, 158, 255, 0.2); 
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <aside class="sidebar">
            <div class="logo">åå¸ˆç½‘AIåˆ¶è¯¾ç³»ç»Ÿ</div>
            <div style="padding: 10px 20px;">
                <el-button type="primary" icon="Plus" @click="createNewProject" style="width: 100%; border-radius: 8px;">æ–°å»ºèƒå–è¯¾é¢˜</el-button>
            </div>
            <div style="padding: 15px 25px; font-weight: bold; color: #909399;">å†å²èƒå–è®°å½•</div>
            <div class="history-list" style="flex:1; overflow-y:auto;">
                <div v-for="h in realHistory" :key="h" class="history-item" @click="loadFromHistory(h)">ğŸ“„ {{ h }}</div>
            </div>
            <div style="padding: 20px; font-size: 12px; color: #C0C4CC;">Davidï¼Œä¿æŒå†œå¤«ç²¾ç¥</div>
        </aside>

        <main class="main-content">
            <header class="header">
                <el-button v-if="step > 1" @click="goBack" size="small" style="margin-right: auto;">â† æ’¤é”€å¹¶è¿”å›ä¸Šä¸€æ­¥</el-button>
                <span style="color:#E6A23C; margin-right:20px; font-weight:bold;">ğŸª™ 450</span>
                <el-button type="primary" round size="small">ç§¯åˆ†å……å€¼</el-button>
            </header>

            <div class="workspace">
                <div v-if="step === 0 && !loading" style="text-align:center; margin-top:15vh;">
                    <h1 style="font-size:42px; color:#303133;">AI å·¥ä¸šåŒ–èƒå–æ™ºèƒ½ä½“</h1>
                    <p style="color:#909399;">åŸºäºã€Šè®²å¸ˆè®­ç»ƒå­¦é™¢ã€‹æ ‡å‡†ï¼Œå®ç°ç»éªŒçš„é«˜æ•ˆè½¬åŒ–</p>
                    <div style="width:600px; margin:40px auto;">
                        <el-input v-model="topic" placeholder="è¾“å…¥è¯¾é¢˜åç§°" size="large">
                            <template #append><el-button type="primary" @click="runWorkflow(1)">å¼€å¯å®šä½</el-button></template>
                        </el-input>
                        <el-upload drag :action="`${API_BASE}/api/course/upload-experience`" :on-success="handleUploadSuccess">
                            <el-icon class="el-icon--upload"><upload-filled /></el-icon>
                            <div class="el-upload__text">å°†æ–‡ç¨¿æ‹–åˆ°æ­¤å¤„ï¼Œæˆ–<em>ç‚¹å‡»ä¸Šä¼ </em></div>
                        </el-upload>
                    </div>
                </div>

                <div v-if="step > 0" class="step-nav">
                    <el-steps :active="step - 1" finish-status="success" align-center>
                        <el-step v-for="(s, i) in stepNames" :key="s" :title="s" @click.native="jumpToPage(i+1)" style="cursor:pointer"></el-step>
                    </el-steps>
                </div>

                <div v-if="step === 1 && !loading" class="content-card">
                    <el-row :gutter="40">
                        <el-col :span="10"><div id="radarDom" class="radar-chart"></div></el-col>
                        <el-col :span="14">
                            <h3>è¯¾ç¨‹å®šä½è¯„ä¼°æŠ¥å‘Š</h3>
                            <div style="background:#f8fbff; padding:20px; border-radius:8px;" v-html="workflowHistory[1]?.analysis"></div>
                            <el-button type="primary" style="width:100%; margin-top:25px;" @click="runWorkflow(2)">ä¸‹ä¸€æ­¥ï¼šéœ€æ±‚åˆ†æ</el-button>
                        </el-col>
                    </el-row>
                </div>

                <div v-if="step === 2 && !loading" class="content-card">
                    <h3>å…¸å‹ä¸šåŠ¡åœºæ™¯ä¸éœ€æ±‚æº¯æº</h3>
                    <el-table :data="workflowHistory[2]?.items" border stripe>
                        <el-table-column prop="scene" label="å®æˆ˜åœºæ™¯"></el-table-column>
                        <el-table-column prop="problem" label="æ ¸å¿ƒç—›ç‚¹"></el-table-column>
                        <el-table-column prop="goal" label="æ•™å­¦ç›®æ ‡"></el-table-column>
                    </el-table>
                    <el-button type="primary" style="width:100%; margin-top:20px;" @click="runWorkflow(3)">ä¸‹ä¸€æ­¥ï¼šè¯¾ç¨‹ç»“æ„</el-button>
                </div>

                <div v-if="step === 3 && !loading" class="content-card">
                    <h3>å››çº§ç»“æ„å»ºæ¨¡ (Why-What-How-If only)</h3>
                    <div v-for="(ch, i) in workflowHistory[3]?.chapters" :key="i" style="margin-bottom:20px;">
                        <h4 style="color:#409EFF;">ç¬¬ {{i+1}} ç« ï¼š{{ ch.title }}</h4>
                        <el-card shadow="never" body-style="padding:10px 20px;">
                            <div v-for="sec in ch.sections" :key="sec" style="padding:8px 0; border-bottom:1px solid #f2f6fc;">{{ sec }}</div>
                        </el-card>
                    </div>
                    <el-button type="primary" style="width:100%;" @click="runWorkflow(4)">ä¸‹ä¸€æ­¥ï¼šè¯¾ç¨‹æ¡ˆä¾‹</el-button>
                </div>

                <div v-if="step === 4 && !loading" class="content-card">
                    <h3>å®è¯æ¡ˆä¾‹èƒå–</h3>
                    <el-row :gutter="20">
                        <el-col :span="12" v-for="c in workflowHistory[4]?.cases" :key="c.content">
                            <el-card shadow="hover" :body-style="{ background: c.type === 'æ­£å‘' ? '#f0f9eb' : '#fef0f0' }">
                                <el-tag :type="c.type === 'æ­£å‘' ? 'success' : 'danger'">{{ c.type }}æ¡ˆä¾‹</el-tag>
                                <p style="margin-top:10px;">{{ c.content }}</p>
                            </el-card>
                        </el-col>
                    </el-row>
                    <el-button type="primary" style="width:100%; margin-top:20px;" @click="jumpToPage(5)">è¿›å…¥ä¸‹ä¸€æ­¥ï¼šè¯¾ç¨‹ç¾åŒ–</el-button>
                </div>

                <div class="workspace">
                    <div v-if="step === 5" class="content-card">
                        <h3>è¯¾ç¨‹ç¾åŒ–ä¸å¿ƒæ™ºåŒ…è£…</h3>
                        <p style="color:#909399; margin-bottom:25px;">Davidï¼Œè¯·ç‚¹å‡»é€‰æ‹©æˆ–é‡æ–°åˆ‡æ¢è¯¾ç¨‹é£æ ¼ï¼š</p>
                        <el-row :gutter="20" style="margin-bottom:30px;">
                            <el-col :span="8" v-for="s in ['å®æˆ˜å‹', 'å­¦æœ¯å‹', 'æ ‡é¢˜å…š']" :key="s">
                                <div :class="['style-card', { 'selected': selStyle === s }]" @click="selStyle = s">
                                    <el-icon style="font-size:30px;"><Brush /></el-icon>
                                    <h4>{{ s }}</h4>
                                </div>
                            </el-col>
                        </el-row>
                        <el-button type="primary" style="width:100%; height:50px;" @click="runAI(5)">ç¡®è®¤é£æ ¼å¹¶ç”Ÿæˆå‘½åå»ºè®®</el-button>
                        
                        <div v-if="workflowHistory[5]" style="margin-top:30px;">
                            <el-divider>AI å»ºè®®åç§°</el-divider>
                            <el-alert v-for="n in workflowHistory[5].names" :key="n.name" :title="n.name" :description="n.reason" type="info" show-icon style="margin-bottom:10px;"></el-alert>
                            <el-button type="success" plain style="width:100%; margin-top:20px;" @click="runAI(6)">ç¡®å®šå¹¶è¿›å…¥ï¼šå­¦å‘˜æ‰‹å†Œèƒå–</el-button>
                        </div>
                    </div>

                    <div v-if="step === 6" class="content-card">
                        <h3>å­¦å‘˜æ‰‹å†Œ (PPT è§†è§‰æ’å¸ƒ)</h3>
                        <el-table :data="workflowHistory[6]?.slides" border stripe style="margin-bottom:25px;">
                            <el-table-column label="é¡µç " type="index" width="60"></el-table-column>
                            <el-table-column prop="title" label="æ ‡é¢˜" width="180"></el-table-column>
                            <el-table-column prop="visual" label="è§†è§‰é…å›¾/é€»è¾‘æè¿°"></el-table-column>
                            <el-table-column prop="time" label="æ—¶é•¿(min)" width="100"></el-table-column>
                        </el-table>
                        
                        <div style="display: flex; gap: 15px;">
                            <el-button type="warning" icon="Download" @click="exportPPT" style="flex: 1; height: 50px;">ä¸‹è½½ä¸“ä¸š PPTX</el-button>
                            <el-button type="primary" @click="runAI(7)" style="flex: 2; height: 50px;">ç¡®è®¤ç»“æ„ï¼Œç”Ÿæˆè®²å¸ˆæ‰‹å†Œ</el-button>
                        </div>
                    </div>

                    <div v-if="step === 7" class="content-card">
                        <h3>æ•™å­¦æŒ‡å¼•ä¸è®²å¸ˆæ‰‹å†Œ</h3>
                        <el-tabs type="border-card" v-if="workflowHistory[7]">
                            <el-tab-pane label="ğŸ™ è¯•è®²è„šæœ¬">
                                <div style="white-space: pre-wrap; line-height:1.8; padding:15px;">{{ workflowHistory[7].script }}</div>
                            </el-tab-pane>
                            <el-tab-pane label="ğŸ’¬ äº’åŠ¨ä¸ç»ƒä¹ ">
                                <el-timeline style="padding:20px;">
                                    <el-timeline-item v-for="it in workflowHistory[7].interacts" :key="it" type="primary">{{ it }}</el-timeline-item>
                                </el-timeline>
                            </el-tab-pane>
                        </el-tabs>
                        <el-button type="success" style="width:100%; margin-top:30px;" @click="createNewProject">å®Œæˆæœ¬æ¬¡èƒå–ï¼Œå›åˆ°é¦–é¡µ</el-button>
                    </div>
                </div>

                <div v-if="loading" style="text-align:center; padding:100px 0;">
                    <el-icon class="is-loading" style="font-size: 50px; color:#409EFF;"><Loading /></el-icon>
                    <h2>AI æ­£åœ¨ä¸ºæ‚¨èƒå–ï¼š{{ currentTaskName }}</h2>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, reactive, nextTick, onMounted } = Vue;
        // æ³¨æ„ï¼šç¡®ä¿æµè§ˆå™¨å·²ç»åŠ è½½äº† @element-plus/icons-vue
        const app = createApp({
            setup() {
                const serverIP = window.location.hostname; 
                const API_BASE = `http://${serverIP}:8080`;
                const PPT_SERVICE = `http://${serverIP}:3001`;
                const step = ref(0);
                const topic = ref('');
                const loading = ref(false);
                const selStyle = ref('å®æˆ˜å‹'); 
                const realHistory = ref([]);
                const workflowHistory = reactive({});
                const currentTaskName = ref('');
                const stepNames = ['è¯¾ç¨‹å®šä½', 'éœ€æ±‚åˆ†æ', 'è¯¾ç¨‹ç»“æ„', 'è¯¾ç¨‹æ¡ˆä¾‹', 'è¯¾ç¨‹ç¾åŒ–', 'å­¦å‘˜æ‰‹å†Œ', 'è®²å¸ˆæ‰‹å†Œ'];

                // 1. ç‰©ç†åŠ è½½
                const syncFromPhysical = async (name, targetStep) => {
                    loading.value = true;
                    try {
                        const res = await axios.get(`${API_BASE}/api/course/load-full-project?topic=${encodeURIComponent(name)}`);
                        Object.keys(workflowHistory).forEach(k => delete workflowHistory[k]);
                        Object.assign(workflowHistory, res.data);
                        topic.value = name;
                        step.value = targetStep || (Object.keys(res.data).length > 0 ? Math.max(...Object.keys(res.data).map(Number)) : 1);
                        if(step.value === 1 && workflowHistory[1]) {
                            nextTick(() => initRadar(workflowHistory[1].metrics));
                        }
                    } finally { loading.value = false; }
                };

                // âœ… ç»Ÿä¸€å‡½æ•°åï¼šHTML ä¸­è°ƒç”¨çš„æ˜¯ runAIï¼Œè¿™é‡Œå°±å®šä¹‰ runAI
                const runAI = async (target) => {
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API_BASE}/api/course/process`, {
                            step: target,
                            topic: topic.value,
                            selectedStyle: selStyle.value,
                            history: JSON.stringify(workflowHistory) // âœ… ç¡®ä¿ä¼ é€’äº†ä¹‹å‰çš„å…¨éƒ¨èƒå–æˆæœ
                        });
                        
                        // ç‰©ç†å­˜æ¡£å†™å…¥ [cite: 2026-02-19]
                        workflowHistory[target] = res.data;
                        
                        // ğŸ’¡ ä¿®æ­£ï¼šç”Ÿæˆå“ªä¸€æ­¥ï¼Œå°±åœç•™åœ¨å“ªä¸€æ­¥ï¼Œè®©ç”¨æˆ·çœ‹åˆ°ç»“æœï¼
                        window.location.hash = `#/course/${encodeURIComponent(topic.value)}/${target}`;
                        
                        ElementPlus.ElMessage.success(`${stepNames[target-1]} èƒå–æˆåŠŸ`);
                    } catch (e) {
                        ElementPlus.ElMessage.error('AI èƒå–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç‰©ç†å­˜æ¡£ logs æ–‡ä»¶å¤¹');
                    } finally {
                        loading.value = false;
                    }
                };

                const navigateToStep = (s) => {
                    window.location.hash = `#/course/${encodeURIComponent(topic.value)}/${s}`;
                };

                const jumpToPage = (s) => {
                    if (workflowHistory[s] || s === 1 || s === 5) navigateToStep(s);
                    else ElementPlus.ElMessage.warning('è¯·æŒ‰é¡ºåºå®Œæˆèƒå–');
                };

                const initRadar = (m) => {
                    const dom = document.getElementById('radarDom');
                    if (!dom || !m) return;
                    echarts.dispose(dom);
                    const chart = echarts.init(dom);
                    chart.setOption({
                        radar: { indicator: [{name:'ç¨€ç¼º',max:25},{name:'å®ç”¨',max:25},{name:'é²œæ´»',max:25},{name:'é¢—ç²’',max:25}] },
                        series: [{ type:'radar', data:[{value:[m.rarity, m.utility, m.freshness, m.granularity]}] }]
                    });
                };

                const handleRoute = () => {
                    const h = window.location.hash;
                    if (h.startsWith('#/course/')) {
                        const parts = h.replace('#/course/', '').split('/');
                        syncFromPhysical(decodeURIComponent(parts[0]), parts[1] ? parseInt(parts[1]) : 1);
                    } else {
                        step.value = 0; topic.value = '';
                    }
                };

                const fetchFiles = async () => {
                    const res = await axios.get(`${API_BASE}/api/course/list-files`);
                    realHistory.value = res.data;
                };

                window.addEventListener('hashchange', handleRoute);
                onMounted(() => { fetchFiles(); handleRoute(); });

                // åœ°å€ï¼šai-course.html -> setup() å†…éƒ¨ [cite: 2026-02-20]
                const exportPPT = async () => {
                    // å®¡è®¡ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç”Ÿæˆè¿‡å­¦å‘˜æ‰‹å†Œ [cite: 2026-02-19]
                    const mdSource = workflowHistory[6]?.markdown; 
                    if (!mdSource) return ElementPlus.ElMessage.warning('è¯·å…ˆå®Œæˆå­¦å‘˜æ‰‹å†Œç”Ÿæˆ');

                    try {
                        ElementPlus.ElMessage.info('PPT ç‰©ç†è½¬æ¢ä¸­...');
                        // å¯¹æ¥ä½ è¦æ±‚çš„ 3000 ç«¯å£æœåŠ¡
                        const response = await axios.post(`${PPT_SERVICE}/api/export-pptx`, {
                            markdown: mdSource,
                            fileName: topic.value
                        }, { responseType: 'blob' });

                        const url = window.URL.createObjectURL(new Blob([response.data]));
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `${topic.value}.pptx`;
                        link.click();
                    } catch (e) {
                        ElementPlus.ElMessage.error('å¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¡®è®¤ 3001 ç«¯å£è½¬ç æœåŠ¡å·²å¯åŠ¨');
                    }
                };

                return {
                    step, topic, loading, selStyle, realHistory, workflowHistory, 
                    exportPPT,
                    stepNames, currentTaskName, 
                    runAI, // âœ… è¿™é‡Œçš„åå­—å¿…é¡»å’Œ HTML æ¨¡æ¿é‡Œçš„ @click="runAI" ä¸€è‡´
                    runWorkflow: runAI, // ä¿ç•™åˆ«åé˜²æ­¢å…¶ä»–åœ°æ–¹è°ƒç”¨
                    navigateToStep, jumpToPage,
                    loadFromHistory: (h) => window.location.hash = `#/course/${encodeURIComponent(h)}/1`,
                    createNewProject: () => window.location.hash = '#/',
                    handleUploadSuccess: (res) => { topic.value = res.topic; runAI(1); },
                    API_BASE
                };
            }
        });

        // âœ… æ³¨å†Œå›¾æ ‡åº“ï¼Œå¦åˆ™é¡µé¢å¯èƒ½å¡æ­»
        if (typeof ElementPlusIconsVue !== 'undefined') {
            for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
                app.component(key, component);
            }
        }
        app.use(ElementPlus).mount('#app');
    </script>
</body>
</html>