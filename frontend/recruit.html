<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>SUAT æ‹›è˜ç®¡ç†ä¸­æ¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); }
        .suat-gradient { background: linear-gradient(135deg, #75207D 0%, #a239b0 100%); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #75207D; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<div class="max-w-7xl mx-auto px-6 py-10">
    <div class="flex justify-between items-center mb-10">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">ğŸ“¢ æ‹›è˜ç®¡ç†ä¸­æ¢</h1>
            <p class="text-gray-500">å‘å¸ƒå²—ä½éœ€æ±‚ã€ç®¡ç†åº”è˜è¿›åº¦ä¸ AI è¯„ä¼°ç»“æœ</p>
        </div>
        <button onclick="window.location.href='index.html'" class="px-5 py-2 bg-white border rounded-lg hover:bg-gray-100 transition flex items-center gap-2">
            ğŸ  è¿”å›å¤§å…
        </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1 space-y-6">
            <div class="glass-card p-6 rounded-2xl shadow-sm">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-purple-700">âœï¸ å‘å¸ƒæ‹›è˜éœ€æ±‚</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">æ„å‘å²—ä½</label>
                        <input type="text" id="job-title" placeholder="å¦‚ï¼šæŠ€æœ¯éƒ¨Â·åç«¯å¼€å‘" class="w-full px-4 py-2 border rounded-xl focus:ring-2 ring-purple-200 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">å²—ä½å…³é”®è¯</label>
                        <textarea id="job-desc" placeholder="è¾“å…¥æŠ€æœ¯è¦æ±‚ã€ç´ è´¨è¦æ±‚..." class="w-full px-4 py-2 border rounded-xl h-32 focus:ring-2 ring-purple-200 outline-none"></textarea>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="needs-test" class="rounded text-purple-600">
                        <label for="needs-test" class="text-sm text-gray-500">å¼€å¯ AI è‡ªåŠ¨ç¬”è¯•ç¯èŠ‚</label>
                    </div>
                    <button onclick="generateAd()" id="gen-btn" class="w-full py-3 suat-gradient text-white rounded-xl font-bold hover:opacity-90 transition shadow-lg">
                        âœ¨ AI ç”Ÿæˆæ‹›è˜å¹¿å‘Š
                    </button>
                </div>
            </div>

            <div id="ad-container" class="hidden glass-card p-6 rounded-2xl border-dashed border-2 border-purple-200 animate-pulse">
                <h4 class="text-sm font-bold text-purple-600 mb-2">AI å®£ä¼ æ–‡æ¡ˆé¢„æ£€ï¼š</h4>
                <div id="ad-content" class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap max-h-60 overflow-y-auto custom-scrollbar"></div>
                <button onclick="publishJob()" id="pub-btn" class="mt-4 w-full py-2 bg-purple-700 text-white rounded-lg text-sm font-bold hover:bg-purple-800 transition">
                    ç¡®è®¤å¹¶å‘å¸ƒåˆ°é—¨æˆ·
                </button>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="glass-card p-6 rounded-2xl shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">ğŸ“Š å®æ—¶é¢è¯•åŠ¨æ€</h3>
                    <button onclick="loadCandidates()" class="text-sm text-purple-600 hover:underline">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="text-gray-400 text-sm border-b">
                            <tr>
                                <th class="pb-3 font-medium">å€™é€‰äºº ID</th>
                                <th class="pb-3 font-medium">åº”è˜å²—ä½</th>
                                <th class="pb-3 font-medium">ç‰©ç†çŠ¶æ€</th>
                                <th class="pb-3 font-medium">AI è¯„åˆ†</th>
                                <th class="pb-3 text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="candidate-list" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ğŸš€ åŠ¨æ€è¯†åˆ«åç«¯åœ°å€ï¼Œä¿è¯æ— ç¼è¿ç§»
    const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8080/api' : `http://${window.location.host}/api`;
    const token = localStorage.getItem('token');

    window.onload = () => {
        if(!token) window.location.href = 'login.html';
        loadCandidates();
    };

    // 1. AI è‡ªåŠ¨ç”Ÿæˆå¹¶å®æ—¶æ˜¾ç¤ºæ–‡æ¡ˆ (å¤„ç†æµå¼è¾“å‡º)
    async function generateAd() {
        const title = document.getElementById('job-title').value;
        const desc = document.getElementById('job-desc').value;
        if(!title) return alert("è¯·è¾“å…¥å²—ä½åç§°");

        const btn = document.getElementById('gen-btn');
        const adContainer = document.getElementById('ad-container');
        const adContent = document.getElementById('ad-content');

        btn.innerText = "âš¡ æ­£åœ¨æ„æ€æ–‡æ¡ˆ...";
        btn.disabled = true;
        adContainer.classList.remove('hidden');
        adContent.innerText = "";

        try {
            const res = await fetch(`${API_BASE}/ai/chat/stream`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ 
                    message: `è¯·ä½œä¸ºä¸“ä¸šHRï¼Œä¸ºå²—ä½[${title}]ç”Ÿæˆä¸€æ®µå¸å¼•äººçš„ç¤¾å›¢æ‹›è˜ç®€ç« ã€‚è¦æ±‚ï¼š[${desc}]ã€‚åŒ…å«ï¼šã€å²—ä½ç®€ä»‹ã€‘ã€ç¡¬æ ¸è¦æ±‚ã€‘ã€ç‹¬å®¶ç¦åˆ©ã€‘ã€‚`, 
                    modelKey: 'anything-llm',
                    sessionId: 'job-ad-gen'
                })
            });

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                lines.forEach(line => {
                    if (line.startsWith('data:')) {
                        const data = line.substring(5).trim();
                        if (data === '[DONE]') return;
                        try {
                            const json = JSON.parse(data);
                            const text = json.choices?.[0]?.delta?.content || "";
                            adContent.innerText += text;
                        } catch(e) {}
                    }
                });
            }
            adContainer.classList.remove('animate-pulse');
        } catch (e) {
            alert("AI å¼•æ“è¿æ¥å¤±è´¥");
        } finally {
            btn.innerText = "âœ¨ é‡æ–°ç”Ÿæˆå¹¿å‘Š";
            btn.disabled = false;
        }
    }

    // 2. ğŸš€ å…³é”®ä¿®å¤ï¼šç‚¹å‡»å‘å¸ƒï¼Œå°†æ•°æ®å­˜å…¥æ•°æ®åº“
    async function publishJob() {
        const title = document.getElementById('job-title').value;
        const desc = document.getElementById('job-desc').value;
        const adText = document.getElementById('ad-content').innerText;
        const needsTest = document.getElementById('needs-test').checked;

        if(!adText) return alert("è¯·å…ˆç”Ÿæˆå¹¿å‘Šæ–‡æ¡ˆ");

        const pubBtn = document.getElementById('pub-btn');
        pubBtn.innerText = "æ­£åœ¨åŒæ­¥è‡³äº‘ç«¯...";
        pubBtn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/jobs/publish`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({
                    title: title,
                    description: desc,
                    adText: adText,
                    status: "OPEN"
                    // å¦‚æœä½ åç«¯åŠ äº† needsTest å­—æ®µï¼Œè¿™é‡Œä¹Ÿå¯ä»¥ä¼ 
                })
            });

            if(res.ok) {
                alert("ğŸ‰ å‘å¸ƒæˆåŠŸï¼å²—ä½å·²ç‰©ç†æ¨é€åˆ°åº”è˜è€…å¤§å…ã€‚");
                document.getElementById('ad-container').classList.add('hidden');
            } else {
                alert("å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯ Job å®ä½“æ˜¯å¦å·²åˆ›å»º");
            }
        } catch (e) {
            alert("ç½‘ç»œæ•…éšœ");
        } finally {
            pubBtn.innerText = "ç¡®è®¤å¹¶å‘å¸ƒåˆ°é—¨æˆ·";
            pubBtn.disabled = false;
        }
    }

    // 3. åŠ è½½å€™é€‰äºº (è°ƒç”¨ä½ çš„ä¸šåŠ¡æ¥å£ /candidates)
    async function loadCandidates() {
        try {
            const res = await fetch(`${API_BASE}/recruit/candidates`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            const list = document.getElementById('candidate-list');
            list.innerHTML = data.map(user => `
                <tr class="hover:bg-purple-50 transition-colors">
                    <td class="py-4 font-bold text-gray-700">${user.username}</td>
                    <td class="py-4 text-sm text-gray-500">å·²å…³è”ç®€å†</td>
                    <td class="py-4">
                        <span class="px-2 py-1 rounded-md text-xs font-bold ${user.status === 'ACTIVE' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                            ${user.status === 'ACTIVE' ? 'æ­£åœ¨æµ‹è¯•' : 'å¾…å¤„ç†'}
                        </span>
                    </td>
                    <td class="py-4 font-mono text-purple-600 font-bold">å¾…è¯„åˆ†</td>
                    <td class="py-4 text-right">
                        <button onclick="alert('æ­£åœ¨è°ƒå– ${user.username} çš„ç‰©ç†ç¬”å½•...')" class="text-xs bg-white border px-3 py-1 rounded-lg shadow-sm hover:bg-gray-100">è°ƒå–ç¬”å½•</button>
                    </td>
                </tr>
            `).join('');
        } catch (e) { console.log("åŠ è½½å¤±è´¥"); }
    }
</script>
</body>
</html>